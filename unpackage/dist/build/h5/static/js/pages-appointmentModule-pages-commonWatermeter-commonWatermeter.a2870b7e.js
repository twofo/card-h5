(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["pages-appointmentModule-pages-commonWatermeter-commonWatermeter"],{"04a6":function(e,t,o){"use strict";o.r(t);var a=o("3d5e"),i=o.n(a);for(var n in a)"default"!==n&&function(e){o.d(t,e,(function(){return a[e]}))}(n);t["default"]=i.a},3350:function(e,t){var o="/static/pages/appointmentModule/resources/pic",a={image:o,optionAppointmentPic:"".concat(o,"/option_appointment.png"),optionAttendanceApprovePic:"".concat(o,"/option_attendance_approve.png"),optionMakeCardApplyPic:"".concat(o,"/option_make_card_apply.png"),meetingAttendanceListPic:"".concat(o,"/meeting_attendance_list.png"),meetingAttendanceSignInPic:"".concat(o,"/meeting_attendance_sign_in.png"),blueRecord:"".concat(o,"/blueRecord.png"),closeDefault:"".concat(o,"/closeDefault.png"),closeOpen:"".concat(o,"/closeOpen.png"),loadingPic:"".concat(o,"/loading.png"),checkPendingPic:"".concat(o,"/check_pending.png"),approvePic:"".concat(o,"/approve.png"),unapprovePic:"".concat(o,"/unapprove.png"),nostartPic:"".concat(o,"/nostart.png"),readyStartPic:"".concat(o,"/action.png"),submitCluePic:"".concat(o,"/submit_clue.png"),meetingRoomSmallPic:"".concat(o,"/meeting_room_small.png"),meetingRoomMiddlePic:"".concat(o,"/meeting_room_middle.png"),meetingRoomBigPic:"".concat(o,"/meeting_room_big.png"),meetingRoomFrobidPic:"".concat(o,"/meeting_room_frobid.png"),requiredPic:"".concat(o,"/required.png"),attendaceRightPic:"".concat(o,"/right.png"),attendaceErrorPic:"".concat(o,"/error.png"),readyStartingPic:"".concat(o,"/stating.png"),uploadImgPic:"".concat(o,"/Group.png"),blueSignPic:"".concat(o,"/blueSign.png"),changGuanAppiontPic:"".concat(o,"/PIM.png"),meetingRecordPic:"".concat(o,"/meetingRecord.png"),meetingRoomPic:"".concat(o,"/meetingRoom.png"),pianoRoomPic:"".concat(o,"/pianoRoom.png"),dancingPic:"".concat(o,"/dancing.png"),dancingListPic:"".concat(o,"/dancingList.png"),meetingOutPic:"".concat(o,"/meetinOut.png")};e.exports=a},"3d5e":function(e,t,o){"use strict";var a=o("4ea4");o("99af"),o("c975"),o("a15b"),o("a434"),o("a9e3"),o("d3b7"),o("acd8"),o("e25e"),o("4d63"),o("ac1f"),o("25f0"),o("466d"),Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=a(o("c783")),n=o("3350"),c=getApp(),l=(c.globalData.arrayBufferDemo,c.globalData.bluetoothUtil),r=c.globalData.agreementUtil,s=[],d="",u={},g=0,h={data:function(){return{waterBase:[1,2],ImageUrls:n,baseStatus:"点击使用",isContent:0,switchWaterMeter:0,showDeviceInfo:{},command:"",retrueCommand:"",dormDeviceId:"",balance:0,msgObj:{},isGetBluetoothInfo:0,connectDeviceInfo:{},isFristIn:0,deviceId:"",serviceId:"",readCharacteristicId:"",writeCharacteristicId:"",isIOS:0,isShowSwitch:!0,roomName:"",checked:!1,deviceName:"",isPublic:"",startSearch:!1}},components:{msgSelect:i.default},props:{},onLoad:function(e){console.log("----------------------------------------蓝牙操作用水页面----------------------------------------"),console.log("options - ",e),wx.stopBluetoothDevicesDiscovery();var t={connectStatus:"未连接",deviceName:"暂无"};this.setData({isIOS:e.isIOS,isPublic:e.isPublic,roomName:e.roomName,showDeviceInfo:t}),e&&e.isIOS&&(t.connectStatus="未连接",t.deviceName=e.roomName,"undefined"!=e.deviceId&&null!=e.deviceId&&""!=e.deviceId&&(t.connectStatus="已连接",this.setData({isShowSwitch:!1,dormDeviceId:e.deviceId}),this.initializeBluetooth(e.deviceId)),this.setData({showDeviceInfo:t}))},onShow:function(){c.globalData.ShowMsgUtil.showLoadToast("加载中..."),this.getBalance(1);var e=c.globalData.StorageUtil.get("connectDeviceInfo");1==this.isGetBluetoothInfo&&e&&(this.getConnectDeviceInfo(e),this.setData({connectDeviceInfo:e,deviceId:e}))},onUnload:function(){console.log("生命周期函数--监听页面卸载"),wx.stopBluetoothDevicesDiscovery(),wx.closeBluetoothAdapter(),c.globalData.StorageUtil.remove("connectDeviceInfo")},methods:{bluetoothSwitch:function(){this.initializeBluetooth(this.dormDeviceId)},goToContent:function(){1!=this.switchWaterMeter?1==this.isIOS?c.globalData.PublicUtil.navigateByUrl(c.globalData.PageUrl.appointmentPageUrl.contentWatermeterUrl+"?roomName="+this.roomName,500):c.globalData.PublicUtil.navigateByUrl(c.globalData.PageUrl.appointmentPageUrl.contentWatermeterUrl,500):c.globalData.ShowMsgUtil.showErrorModal("操作失败","水表使用过程中，无法切换设备")},getConnectDeviceInfo:function(e){e||(e=this.deviceId),console.log("----------------------------------------获取连接设备信息----------------------------------------");var t=this;console.log("1、开始获取设备信息, deviceId - ",e),wx.getBLEDeviceServices({deviceId:e,success:function(o){var a=l.getAvailableService(o.services);console.log("service",a);var i=a.uuid;console.log("2、获取连接设备特征值, serviceId - ",i),wx.getBLEDeviceCharacteristics({deviceId:e,serviceId:i,success:function(o){o.characteristics[1];var a=l.getAvailableReadCharacters(o.characteristics).uuid,n=l.getAvailableWriteCharacters(o.characteristics).uuid;console.log("readCharacteristicId",a),console.log("writeCharacteristicId",n);var s={connectStatus:"已连接"};console.log("roomName - ",t.roomName),console.log("roomName - ",""!=t.roomName||null!=t.roomName),s.deviceName=""!=t.roomName&&null!=t.roomName?t.roomName:t.deviceName,t.setData({isFristIn:1,isContent:1,showDeviceInfo:s,serviceId:i,readCharacteristicId:a,writeCharacteristicId:n}),console.log("3、启用/停用 低功耗蓝牙设备特征值变化时的notify功能，订阅特征值"),wx.notifyBLECharacteristicValueChange({state:!0,deviceId:e,serviceId:i,characteristicId:a,success:function(){console.log(">>>>>>>>>开始监听特征值"),wx.onBLECharacteristicValueChange((function(e){var o=r.buf2hex(e.value);console.log(">>>>>>>>>更新后的特征值(16进制格式)",o),t.setData({retrueCommand:o}),t.handleReadDeviceReturn(e.value)})),t.toAuth()},fail:function(e){console.warn("监听特征值失败"),c.globalData.ShowMsgUtil.showErrorModal("水表连接失败","请稍后再试")}})},fail:function(e){console.warn("获取特征值信息失败",e),c.globalData.ShowMsgUtil.showErrorModal("水表连接失败","请稍后再试")},complete:function(e){console.log("获取服务信息完成",e),wx.hideLoading()}})},fail:function(e){console.warn("获取服务信息失败",e),c.globalData.ShowMsgUtil.showErrorModal("水表连接失败","请稍后再试")},complete:function(){wx.hideLoading()}})},toAuth:function(){var e=r.writeAuth();this.bluetoothSendCommand(e)},operateWaterMeter:function(){0==this.isContent&&this.dormDeviceId?this.startBluetoothDevicesDiscovery():this.handleOperate()},handleOperate:function(){var e=this;if(console.log(">>>>>>>>>>isContent - ",e.isContent),0==e.isContent)this.getConnectDeviceInfo();else if(1==e.isContent){var t=e.switchWaterMeter;0==t?(c.globalData.ShowMsgUtil.showLoadToast("水表开启中..."),e.openWaterMeter()):1==t&&(c.globalData.ShowMsgUtil.showLoadToast("水表关闭中..."),e.closeWaterMeter())}else c.globalData.ShowMsgUtil.showErrorModal("无法用水","请稍后再试")},openWaterMeter:function(){var e={};this.issueAuthorizationMoney(e,1)},handleFristIssueWebReturn:function(e){var t=c.globalData.StorageUtil.get("userInfoCach"),o=r.writeOpenWaterMeter(e,t.userId);this.bluetoothSendCommand(o)},closeWaterMeter:function(){console.log(" ----- 点击关闭水表操作");var e=r.writeCloseWaterMeter();this.bluetoothSendCommand(e)},handleSecondIssueWebReturn:function(e){var t=r.writeIssuedByLineRetrue(e);this.bluetoothSendCommand(t)},handleReadDeviceReturn:function(e){console.log("----------------------------------------读取 - 监听设备返回小程序业务处理----------------------------------------");var t=this.handlerRead(e);if(t){switch(t.type){case 1:console.log("开启水表 - 设备返回数据处理"),this.handleOpenReadDeviceReturn(t);break;case 2:console.log("关闭水表 - 设备返回数据处理"),this.handleCloseReadDeviceReturn(t);break;case 3:console.log("上报水量 - 设备返回数据处理"),this.handleWaterReportReadDeviceReturn(t),console.log("读取 - 水表水量上报，设备请求",t);break;case 4:console.log("重新下发授权额度 - 设备返回数据处理");var o={};this.issueAuthorizationMoney(o,0);break;case 5:console.log("App授权认证 - 设备返回数据处理"),this.handleAppAutoReadDeviceReturn(t);break;default:console.warn("此返回数据格式不正确");break}console.log(">>>>>>>>>>>>>>>>>>>>>>obj",t)}},handleOpenReadDeviceReturn:function(e){var t,o;1==e.operaResult?(t="点击关闭",o=1,wx.hideToast({}),c.globalData.ShowMsgUtil.showLoadToast("开启成功",1e3),this.handleDeviceStorage(e)):(t="点击开启",o=0,wx.hideToast({}),c.globalData.ShowMsgUtil.showLoadToast("开启失败",1e3),this.closeWaterMeter(),wx.hideToast({})),this.setData({baseStatus:t,switchWaterMeter:o})},handleDeviceStorage:function(e){console.log("开启成功的设备 - ",e.deviceId);for(var t=!1,o=0==c.globalData.StorageUtil.get("connectDeviceCach").length?[]:c.globalData.StorageUtil.get("connectDeviceCach"),a=0;a<o.length;a++)o[a].deviceId===this.deviceId&&o[a].deviceName===this.showDeviceInfo.deviceName&&o[a].deviceCode===e.deviceId&&o[a].isIos===this.isIOS&&(console.log("与缓存中有一样的设备"),t=!0);if(!t){var i=o,n={};n.deviceId=this.deviceId,n.deviceCode=e.deviceId,n.deviceName=this.showDeviceInfo.deviceName,n.isIos=this.isIosOrAndrond(),i[o.length]=n,i=this.arrayUnique(i),console.log("数组去重后 - ",i),i=this.removeIllegalData(i),console.log("移除违规后 - ",i),c.globalData.StorageUtil.set("connectDeviceCach",i)}},isIosOrAndrond:function(){var e=0;return wx.getSystemInfo({success:function(t){console.log("获取当前用户的设备类型 - ",t.platform),"devtools"==t.platform?PC:"ios"==t.platform?e=1:"android"==t.platform&&(e=0)}}),e},arrayUnique:function(e){console.log("数组去重前 - ",e);for(var t=[],o=0,a=e.length;o<a;o++){for(var i=o+1;i<a;i++)e[o].deviceCode===e[i].deviceCode&&e[o].deviceId===e[i].deviceId&&(i=++o);t.push(e[o])}return t},removeIllegalData:function(e){console.log("移除违规前 - ",e);for(var t=0;t<e.length;t++)""!=e[t].deviceCode&&""!=e[t].deviceName&&""!=e[t].deviceId&&void 0!=e[t].deviceCode&&void 0!=e[t].deviceName&&void 0!=e[t].deviceId&&void 0!=e[t].isIos||e.splice(t,1);return e},handleCloseReadDeviceReturn:function(e){var t,o;1==e.operaResult?(t="点击开启",o=0,wx.hideToast({}),c.globalData.ShowMsgUtil.showLoadToast("操作中",5e3),this.handleCloseSuccess()):(o=1,wx.hideToast({}),c.globalData.ShowMsgUtil.showLoadToast("水表关闭失败",2e3)),this.setData({baseStatus:t,switchWaterMeter:o})},handleCloseSuccess:function(){wx.hideToast({}),c.globalData.ShowMsgUtil.showLoadToast("关水中",9e3),setTimeout((function(){wx.hideToast({}),c.globalData.ShowMsgUtil.showLoadToast("关水成功！",2e3),console.log("关闭用水后，断开蓝牙连接"),wx.stopBluetoothDevicesDiscovery(),wx.closeBluetoothAdapter(),c.globalData.StorageUtil.remove("connectDeviceInfo"),c.globalData.PublicUtil.switchTabByUrl(c.globalData.PageUrl.taBarPageUrl.indexUrl,2e3)}),7e3)},handleOneWaterReportReadDeviceReturn:function(e){if("{}"!=JSON.stringify(u)?u.whichNumber>e.whichNumber?(g++,u=e,d=e.realData+d):u.whichNumber<e.whichNumber&&(g++,u=e,d+=e.realData):(g=1,u=e,d=e.realData),console.log(">>>>>>>>>>>>>>>>>>>>>>waterReportHowMuch - 00 - ",g),console.log(">>>>>>>>>>>>>>>>>>>>>>waterReportHowMuch - 00 - ",g),console.log(">>>>>>>>>>>>>>>>>>>>>>waterReportArr - 01 - ",s),e.howMuch==g){g=0,console.log(">>>>>>>>>>>>>>>>>>>>>>waterReportArr - 01 - ",s),console.log(">>>>>>>>>>>>>>>>>>>>>>waterReportCommand - 01 - ",d);for(var t=0;t<s.length;t++)0==s[t].isHandle&&this.handlerWaterReport(s[t].waterReportCommand);for(var o=0;o<s.length;o++)if(0==s[o].isHandle&&s[o].waterReportCommand==d)return void console.log("waterReportArr[i].waterReportCommand == waterReportCommand");var a={isHandle:0};a.waterReportCommand=d,s[s.length]=a,console.log(">>>>>>>>>>>>>>>>>>>>>>waterReportArr - 02 - ",s);for(var i=0;i<s.length;i++)0==s[i].isHandle&&this.handlerWaterReport(s[i].waterReportCommand);var n=r.readWaterReport(r.hexbuf2(d));console.log(">>>>>>>>>>>>>>>>>>>>>>waterReportObj - ",n),d="",u={}}},handleWaterReportReadDeviceReturn:function(e){d=e.realData,console.log(">>>>>>>>>>>>>>>>>>>>>>waterReportArr - 01 - ",s),console.log(">>>>>>>>>>>>>>>>>>>>>>waterReportArr - 01 - ",s);for(var t=0;t<s.length;t++)s[t].waterReportCommand.length<70&&s.splice(t,1);console.log(">>>>>>>>>>>>>>>>>>>>>>readData - 00 - ",e.realData),console.log(">>>>>>>>>>>>>>>>>>>>>>waterReportArr - 01 - ",s);for(var o=0;o<s.length;o++)0==s[o].isHandle&&(console.log("waterReportArr[i].flag - ",s[o].flag),this.handlerWaterReport(s[o].waterReportCommand,s[o].flag));for(var a=0;a<s.length;a++)if(0==s[a].isHandle&&s[a].waterReportCommand==d)return void console.log("waterReportArr[i].waterReportCommand == waterReportCommand");var i={isHandle:0};i.waterReportCommand=d,i.flag=e.flag,s[s.length]=i,console.log(">>>>>>>>>>>>>>>>>>>>>>waterReportArr - 02 - ",s);for(var n=0;n<s.length;n++)0==s[n].isHandle&&(console.log("waterReportArr[i].flag - ",s[n].flag),this.handlerWaterReport(s[n].waterReportCommand,s[n].flag));d="",u={}},handleReportWebReturn:function(e,t){console.log("水量上报 - 平台处理成功，发送处理结果给设备.",e,t);var o=r.writeWaterReportRetrue(e,t);this.bluetoothSendCommand(o)},handleAppAutoReadDeviceReturn:function(e){var t=c.globalData.StorageUtil.get("userInfoCach"),o=1;if(null==e)return o=2,this.setData({baseStatus:"无法用水",isContent:o}),void c.globalData.ShowMsgUtil.showErrorModal("水表连接失败","无法通信");if(1==e.isLock)return o=2,console.warn("水表已锁定"),this.setData({baseStatus:"水表已锁定",isContent:o}),void c.globalData.ShowMsgUtil.showErrorModal("水表连接失败","水表已经被锁定");if(1==e.isOpen)if(e.userId==t.userId){var a=1;this.setData({baseStatus:"点击关闭",switchWaterMeter:a})}else e.userId!=t.userId?(o=2,"有人在使用",console.warn("水表状态 - 有人在使用，请稍后再试"),c.globalData.ShowMsgUtil.showErrorModal("请稍后再试","有人正在用水"),this.setData({baseStatus:"无法用水",isContent:o})):(o=2,"水表状态未知",console.warn("水表状态 - 未知"),c.globalData.ShowMsgUtil.showErrorModal("水表连接失败","获取水表信息有误"),this.setData({baseStatus:"无法用水",isContent:o}));else if(0==e.isOpen&&(console.log("水表状态 - 正常使用"),this.dormDeviceId))return void this.handleOperate()},bluetoothCommunication:function(){},bluetoothRecevieCommand:function(){console.log("----------------------------------------读取 - 手机接收设备指令----------------------------------------");var e=this;wx.onBLECharacteristicValueChange((function(e){console.log("characteristic ".concat(e.characteristicId," has changed, now is ").concat(e.value)),console.log(r.buf2hex(e.value))})),wx.readBLECharacteristicValue({deviceId:e.deviceId,serviceId:e.serviceId,characteristicId:e.readCharacteristicId,success:function(e){console.log("readBLECharacteristicValue:"),console.log(e)}})},bluetoothSendCommand:function(e){var t=this;wx.writeBLECharacteristicValue({deviceId:t.deviceId,serviceId:t.serviceId,characteristicId:t.writeCharacteristicId,value:e,success:function(e){console.log("writeBLECharacteristicValue success",e)},fail:function(e){console.log("writeBLECharacteristicValue fail",e)}})},inputCommand:function(e){console.log(">>>>>>>e - ",e.detail.value),this.setData({command:e.detail.value})},handlerBluetoothCommunicationTimeout:function(){},onCloseConnect:function(){wx.closeBLEConnection({deviceId:this.deviceId,success:function(e){console.log("成功断开连接"),wx.showToast({title:"成功断开连接"})}})},handlerWrite:function(e,t){var o;switch(Number(e)){case 1:o=r.writeOpenWaterMeter(100,3911),console.log("开启水表，小程序请求");break;case 2:o=r.writeCloseWaterMeter(),console.log("关闭水表，小程序请求");break;case 3:o=r.writeWaterReportRetrue(),console.log("水表水量上报，小程序返回");break;case 4:o=r.writeIssuedByLineRetrue(10),console.log("重新下发授权额度，小程序返回");break;default:console.log("蓝牙通信指令有误");break}return o},handlerRead:function(e){var t={},o=r.readData(e);switch(console.log("operationtype - ",o),console.log("读取 - buffer - ",e),o){case"01":t=r.readOpenWaterMeter(e),console.log("读取 - 开启水表，设备返回");break;case"02":t=r.readCloseWaterMeter(e),console.log("读取 - 关闭水表，设备返回");break;case"03":t=r.readWaterReport(e),console.log("读取 - 水表水量上报，设备请求");break;case"04":t=r.readIssuedByLine(e),console.log("读取 - 重新下发授权额度，设备请求");break;case"05":t=r.readAuth(e),console.log("读取 - App授权认证，设备返回");break;default:console.log("蓝牙通信指令有误");break}return t},issueAuthorizationMoney:function(e,t){var o=this;c.globalData.ShowMsgUtil.netErrNotice();var a=c.globalData.StorageUtil.get("userInfoCach");return wx.request({url:c.globalData.RequestUrl.baseRequestUrl.issueAuthorizationMoney,method:"POST",header:{token:a.token},data:e,success:function(e){console.log("获取下发授权额度",e.data),e.data&&200==e.data.code?(1==t&&e.data.data>0?o.handleFristIssueWebReturn(e.data.data):0==t&&e.data.data>0&&o.handleSecondIssueWebReturn(e.data.data),o.getBalance(0)):c.globalData.ShowMsgUtil.showErrorModal("提示",e.data.msg,e.data.code)},fail:function(){c.globalData.ShowMsgUtil.showNoneToastByFail()}}),0},unfreeze:function(e){c.globalData.ShowMsgUtil.netErrNotice();var t=c.globalData.StorageUtil.get("userInfoCach");wx.request({url:c.globalData.RequestUrl.baseRequestUrl.unfreeze,method:"POST",header:{token:t.token},data:e,success:function(e){if(console.log("关闭水表后业务处理",e.data),!e.data||200!=e.data.code)return wx.hideToast({}),void c.globalData.ShowMsgUtil.showErrorModal("请求失败",e.data.msg,e.data.code)},fail:function(){wx.hideToast({}),c.globalData.ShowMsgUtil.showNoneToastByFail()}})},handlerWaterReport:function(e,t){var o=this;c.globalData.ShowMsgUtil.netErrNotice();var a=c.globalData.StorageUtil.get("userInfoCach");e.length<70?console.log("水量上报格式有误！"):wx.request({url:c.globalData.RequestUrl.baseRequestUrl.handlerWaterReport,method:"POST",header:{token:a.token},data:{waterReportHexStr:e},success:function(a){if(console.log("用水上报处理",a.data),!a.data||200!=a.data.code)return a.data&&201==a.data.code?void console.log("请求失败,重复提交"):(wx.hideToast({}),o.handleReportWebReturn(0,t),void console.log("请求失败,"+a.data.msg));for(var i=0;i<s.length;i++)s[i].waterReportCommand==e&&(s[i].isHandle=1);o.handleReportWebReturn(1,t),o.getBalance(0)},fail:function(){wx.hideToast({}),o.handleReportWebReturn(0,t),c.globalData.ShowMsgUtil.showNoneToastByFail()}})},getBalance:function(e){var t=this;c.globalData.ShowMsgUtil.netErrNotice();var o=c.globalData.StorageUtil.get("userInfoCach");wx.request({url:c.globalData.RequestUrl.baseRequestUrl.balance,method:"POST",header:{token:o.token},data:{deductionMode:1},success:function(o){if(console.log("获取用户钱包余额处理返回",o.data),o.data&&200==o.data.code){wx.hideToast({});var a=c.globalData.PublicUtil.minuteChanageYuanBalance(o.data.rows.purseBalance.balance);t.setData({balance:a}),1==e&&parseFloat(t.balance)<=parseFloat(0)&&t.msgSelect()}else wx.hideToast({}),c.globalData.ShowMsgUtil.showErrorModal("请求失败",o.data.msg,o.data.code)},fail:function(){wx.hideToast({}),c.globalData.ShowMsgUtil.showNoneToastByFail()}})},startBluetoothDevicesDiscovery:function(){0!=this.checked?(c.globalData.ShowMsgUtil.showLoadToast("正在搜索设备",2e3),wx.startBluetoothDevicesDiscovery({success:function(e){console.log("开始搜索附近蓝牙设备")}})):c.globalData.ShowMsgUtil.showErrorModal("操作失败","请先打开蓝牙开关")},initializeBluetooth:function(e){var t=this;wx.closeBluetoothAdapter({complete:function(o){console.log("关闭蓝牙模块 - ",o),wx.openBluetoothAdapter({success:function(o){console.log("初始化蓝牙设备 - ",o),t.setData({checked:!0}),wx.onBluetoothAdapterStateChange((function(e){console.log("蓝牙适配器状态变化 - ",e);var o=e.available?"蓝牙适配器可用":"蓝牙适配器不可用",a=e.discovering?"正在搜索":"搜索可用";console.log("手机蓝牙是否可用：",o),console.log("是否正在搜素",a);var i=e.available;i||(c.globalData.ShowMsgUtil.showErrorModal("蓝牙连接失败","手机蓝牙不可用："),t.stopBluetoothDevicesDiscovery())})),wx.onBluetoothDeviceFound((function(o){var a;console.log("监听寻找新设备的事件 - ",o.devices[0]),a=1==t.isIOS||1==t.isPublic?e:t.handleAndroid(e);for(var i=0;i<o.devices.length;i++){if(!o.devices[i].deviceId||!o.devices[i].name)return;if(console.log("设备id - "+o.devices[i].deviceId),console.log("宿舍的蓝牙设备id - "+a),-1!=o.devices[i].deviceId.indexOf(a)||-1!=o.devices[i].deviceId.indexOf(a.toLowerCase)){t.stopBluetoothDevicesDiscovery(),t.setData({deviceId:o.devices[i].deviceId}),t.connectDevice(o.devices[i].deviceId);break}}}))},fail:function(e){c.globalData.ShowMsgUtil.showErrorModal("蓝牙连接失败","请检查手机蓝牙是否打开"),console.warn("请检查手机蓝牙是否打开"),t.setData({checked:!1})}})},fail:function(e){c.globalData.ShowMsgUtil.showErrorModal("蓝牙连接失败","请检查手机蓝牙是否打开"),console.warn("请检查手机蓝牙是否打开"),t.setData({checked:!1})}})},handleDormDeviceId:function(e){var t="",o=this;return wx.getSystemInfo({success:function(a){"devtools"==a.platform?PC:"ios"==a.platform?t=o.handleIos(e):"android"==a.platform&&(t=o.handleAndroid(e))}}),t},handleAndroid:function(e){var t=(parseInt(e,16)+2).toString(16).toUpperCase();return this.handleRealValue(t)},handleIos:function(e){},handleRealValue:function(e){var t=new RegExp("[A-Za-z0-9]{1,2}","g"),o=e.match(t);return o.join(":")},connectDevice:function(e){var t=this;c.globalData.ShowMsgUtil.showLoadAndMsgToast("连接水表中..."),wx.createBLEConnection({deviceId:e,timeout:3e4,success:function(o){if(console.log(">>>>>>>>>>>toConnect - res>",o),0==o.errCode){var a=50;setTimeout((function(){wx.setBLEMTU({deviceId:e,mtu:a,success:function(e){console.log("setBLEMTU:success:",e)},fail:function(e){console.error("setBLEMTU:fail:",e)}})}),1e3),c.globalData.StorageUtil.remove("connectDeviceInfo"),console.log(">>>>>>>>>>>toConnect - 连接水表: success"),c.globalData.StorageUtil.set("connectDeviceInfo",e),t.setData({isGetBluetoothInfo:1}),t.getConnectDeviceInfo(e)}else c.globalData.ShowMsgUtil.showErrorModal("提示","不能正常对水表进行连接")},fail:function(e){wx.hideLoading(),10012==e.errCode?c.globalData.ShowMsgUtil.showErrorModal("提示","水表连接超时"):c.globalData.ShowMsgUtil.showErrorModal("提示","水表连接失败"),t.setData({checked:!1})},complete:function(){wx.hideLoading()}})},stopBluetoothDevicesDiscovery:function(){wx.stopBluetoothDevicesDiscovery(),this.setData({startSearch:!1})},msgSelect:function(){var e={btnList:["取消","去充值"],msg:"钱包余额不足",showModel:!0};this.setData({msgObj:e})},bindConfirm:function(){c.globalData.PublicUtil.navigateByUrl(c.globalData.PageUrl.indexPageUrl.walletIndexUrl,500)},bindCancel:function(){var e=this;e.msgObj.showModel=!1,e.setData({msgObj:e.msgObj})}}};t.default=h},"4ca8":function(e,t,o){"use strict";var a;o.d(t,"b",(function(){return i})),o.d(t,"c",(function(){return n})),o.d(t,"a",(function(){return a}));var i=function(){var e=this,t=e.$createElement,o=e._self._c||t;return o("v-uni-view",[e.showModel?o("v-uni-view",{staticClass:"modal-mask",on:{click:function(t){arguments[0]=t=e.$handleEvent(t),e.hideModal.apply(void 0,arguments)}}}):e._e(),e.showModel?o("v-uni-view",{staticClass:"modal-dialog"},[o("v-uni-view",{staticClass:"modal-title myui-center"},[e._v(e._s(e.msg))]),o("v-uni-view",{staticClass:"myui-cell-bottom",staticStyle:{"font-size":"16px","margin-top":"10rpx"}},[o("v-uni-view",{staticClass:"myui-cell-bottom__bd myui-center",on:{click:function(t){arguments[0]=t=e.$handleEvent(t),e.cancel.apply(void 0,arguments)}}},[e._v(e._s(e.btnList[0]))]),o("v-uni-view",{staticClass:"myui-cell-bottom__fd myui-center",on:{click:function(t){arguments[0]=t=e.$handleEvent(t),e.confirm.apply(void 0,arguments)}}},[e._v(e._s(e.btnList[1]))])],1)],1):e._e()],1)},n=[]},"51e8":function(e,t,o){"use strict";var a=o("f7e6"),i=o.n(a);i.a},5710:function(e,t,o){var a=o("24fb");t=a(!1),t.push([e.i,".addBlue[data-v-5471fa64]{font-size:%?42?%;color:#20a4f7}.weui-cells[data-v-5471fa64]{font-size:%?32?%!important}.nomore[data-v-5471fa64]{width:100%;-webkit-box-pack:center;-webkit-justify-content:center;justify-content:center;box-sizing:border-box;color:#999}.weui-center[data-v-5471fa64]{display:-webkit-box;display:-webkit-flex;display:flex;-webkit-align-content:center;align-content:center;-webkit-box-align:center;-webkit-align-items:center;align-items:center}.lastTimeUse[data-v-5471fa64]{font-size:%?24?%;color:#999;width:100%;text-align:left;margin:%?20?% 0 %?30?%}.switchBox[data-v-5471fa64]{width:%?300?%;height:%?300?%;border-radius:50%;background:#e7f4fc;display:-webkit-box;display:-webkit-flex;display:flex;-webkit-box-pack:center;-webkit-justify-content:center;justify-content:center;-webkit-box-align:center;-webkit-align-items:center;align-items:center}.baseCont[data-v-5471fa64]{-webkit-box-orient:vertical;-webkit-box-direction:normal;-webkit-flex-direction:column;flex-direction:column}.switchItem[data-v-5471fa64]{width:%?270?%;height:%?270?%;border-radius:50%;background:#b6def8;display:-webkit-box;display:-webkit-flex;display:flex;-webkit-box-pack:center;-webkit-justify-content:center;justify-content:center;-webkit-box-align:center;-webkit-align-items:center;align-items:center}.switchInfo[data-v-5471fa64]{width:%?240?%;height:%?240?%;border-radius:50%;background:#20a4f7;display:-webkit-box;display:-webkit-flex;display:flex;-webkit-box-align:center;-webkit-align-items:center;align-items:center;-webkit-box-orient:vertical;-webkit-box-direction:normal;-webkit-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;justify-content:center;line-height:1.5;color:#fff;font-size:%?28?%;color:#f7f7f7}\r\n/* //未连接设备背景 */.backgroundColor[data-v-5471fa64]{background:#a7c8dd;box-shadow:0 0 %?14?% 0 rgba(169,177,195,.5)}.openBaseColor[data-v-5471fa64]{background:#2e97d9;box-shadow:0 0 %?46?% %?18?% rgba(120,136,169,.5) inset}.image-items[data-v-5471fa64]{width:30px;height:30px}",""]),e.exports=t},6210:function(e,t,o){var a=o("5710");"string"===typeof a&&(a=[[e.i,a,""]]),a.locals&&(e.exports=a.locals);var i=o("4f06").default;i("40ceb618",a,!0,{sourceMap:!1,shadowMode:!1})},"6d37":function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var a={data:function(){return{}},components:{},props:{showModel:{type:Boolean,default:!1},msg:{type:String,default:"提示"},btnList:{type:Array,default:function(){return["取消","确认"]}}},methods:{confirm:function(){this.$emit("confirm")},cancel:function(){this.$emit("cancel")}}};t.default=a},"9ba5":function(e,t,o){"use strict";var a;o.d(t,"b",(function(){return i})),o.d(t,"c",(function(){return n})),o.d(t,"a",(function(){return a}));var i=function(){var e=this,t=e.$createElement,o=e._self._c||t;return o("v-uni-view",{staticClass:"page"},[o("v-uni-view",{staticClass:"weui-cells",staticStyle:{"font-size":"32rpx"}},[e.isShowSwitch?e._e():o("v-uni-view",{staticClass:"weui-cell",staticStyle:{padding:"10rpx 30rpx"},on:{click:function(t){arguments[0]=t=e.$handleEvent(t),e.bluetoothSwitch.apply(void 0,arguments)}}},[o("v-uni-view",{staticClass:"weui-cell__bd more_bd"},[e._v("蓝牙")]),o("v-uni-view",{staticClass:"weui-cell__ft addBlue"},[o("v-uni-switch",{staticStyle:{zoom:"0.5"},attrs:{type:"switch",disabled:!0,checked:e.checked}})],1)],1),!e.dormDeviceId||e.isIOS&&1==e.isIOS&&e.isShowSwitch?o("v-uni-view",{staticClass:"weui-cell",staticStyle:{padding:"10rpx 30rpx"},on:{click:function(t){arguments[0]=t=e.$handleEvent(t),e.goToContent.apply(void 0,arguments)}}},[o("v-uni-view",{staticClass:"weui-cell__bd more_bd"},[e._v("查找设备")]),o("v-uni-view",{staticClass:"weui-cell__ft addBlue"},[o("v-uni-image",{staticClass:"image-items",attrs:{src:"/static/images/public/search.png"}})],1)],1):e._e(),o("v-uni-view",{staticClass:"weui-cell"},[o("v-uni-view",{staticClass:"weui-cell__bd more_bd"},[e._v("连接状态")]),o("v-uni-view",{staticClass:"weui-cell__ft "},[e._v(e._s(e.showDeviceInfo.connectStatus))])],1)],1),o("msg-select",{attrs:{msg:e.msgObj.msg,showModel:e.msgObj.showModel,btnList:e.msgObj.btnList},on:{confirm:function(t){arguments[0]=t=e.$handleEvent(t),e.bindConfirm.apply(void 0,arguments)},cancel:function(t){arguments[0]=t=e.$handleEvent(t),e.bindCancel.apply(void 0,arguments)}}}),o("v-uni-view",{staticClass:"weui-cells"},[e.waterBase.length<=0?o("v-uni-view",{staticClass:"weui-cell nomore"}):o("v-uni-view",{},[o("v-uni-view",{staticClass:"weui-cell"},[o("v-uni-view",{staticClass:"weui-cell__bd more_bd"},[e._v("设备")]),o("v-uni-view",{staticClass:"weui-cell__ft weui-center"})],1),o("v-uni-view",{staticClass:"weui-cell baseCont"},[o("v-uni-view",{staticClass:"switchWaterBase"},[o("v-uni-view",{staticClass:"switchBox"},[o("v-uni-view",{staticClass:"switchItem",on:{click:function(t){arguments[0]=t=e.$handleEvent(t),e.operateWaterMeter.apply(void 0,arguments)}}},[o("v-uni-view",{class:"switchInfo "+(0==e.isContent||2==e.isContent?"backgroundColor":"")+" "+(1==e.switchWaterMeter?"openBaseColor":"")+"  "},[1==e.switchWaterMeter?o("v-uni-view",[e._v("已开启")]):o("v-uni-view",[e._v("水表")]),0==e.isContent||2==e.isContent?o("v-uni-image",{staticStyle:{width:"80rpx",margin:"10rpx 0"},attrs:{src:e.ImageUrls.closeDefault,mode:"widthFix"}}):o("v-uni-view",[0==e.switchWaterMeter?o("v-uni-image",{staticStyle:{width:"80rpx",margin:"10rpx 0"},attrs:{src:e.ImageUrls.closeOpen,mode:"widthFix"}}):(e.switchWaterMeter,o("v-uni-image",{staticStyle:{width:"80rpx",margin:"10rpx 0"},attrs:{src:e.ImageUrls.closeDefault,mode:"widthFix"}}))],1),o("v-uni-view",[e._v(e._s(e.baseStatus))])],1)],1)],1)],1)],1)],1)],1)],1)},n=[]},b057:function(e,t,o){"use strict";var a=o("6210"),i=o.n(a);i.a},b1cb:function(e,t,o){"use strict";o.r(t);var a=o("9ba5"),i=o("04a6");for(var n in i)"default"!==n&&function(e){o.d(t,e,(function(){return i[e]}))}(n);o("b057");var c,l=o("f0c5"),r=Object(l["a"])(i["default"],a["b"],a["c"],!1,null,"5471fa64",null,!1,a["a"],c);t["default"]=r.exports},b8c5:function(e,t,o){var a=o("24fb");t=a(!1),t.push([e.i,'/* components/common/msgSelect/msgSelect.wxss */\r\n\r\n/* model弹窗 */.modal-mask[data-v-0beaf176]{width:100%;height:100%;position:fixed;top:0;left:0;background:#000;opacity:.3;overflow:hidden;z-index:9000;color:#fff}.modal-dialog[data-v-0beaf176]{width:%?540?%;overflow:hidden;position:fixed;top:50%;left:0;z-index:9999;background:#f9f9f9;margin:%?-180?% %?105?%;border-radius:%?20?%;padding:%?30?% %?20?% %?10?%}.modal-title[data-v-0beaf176]{padding:%?10?% %?20?% %?20?%;font-size:%?36?%;color:#030303}\r\n\r\n/* 按钮 */.myui-cell-bottom[data-v-0beaf176]{display:-webkit-box;display:-webkit-flex;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-webkit-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;justify-content:center;color:#20a4f7;-webkit-align-content:center;align-content:center\r\n  /*align-items: center; */}.myui-cell-bottom[data-v-0beaf176]{padding:10px 15px;position:relative;display:-webkit-box;display:-webkit-flex;display:flex;-webkit-box-align:center;-webkit-align-items:center;align-items:center}.myui-cell-bottom[data-v-0beaf176]:before{content:" ";position:absolute;left:0;top:0;right:0;height:1px;border-top:%?1?% solid #e5e5e5;color:#d9d9d9;left:15px}.myui-cell-bottom[data-v-0beaf176]:first-child:before{display:none}.myui-cell-bottom__bd[data-v-0beaf176]{width:50%}.myui-cell-bottom__fd[data-v-0beaf176]{width:50%;border-left:%?3?% #20a4f7 solid}.myui-center[data-v-0beaf176]{display:-webkit-box;display:-webkit-flex;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-webkit-flex-direction:row;flex-direction:row;-webkit-box-align:center;-webkit-align-items:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;justify-content:center}',""]),e.exports=t},c783:function(e,t,o){"use strict";o.r(t);var a=o("4ca8"),i=o("f827");for(var n in i)"default"!==n&&function(e){o.d(t,e,(function(){return i[e]}))}(n);o("51e8");var c,l=o("f0c5"),r=Object(l["a"])(i["default"],a["b"],a["c"],!1,null,"0beaf176",null,!1,a["a"],c);t["default"]=r.exports},f7e6:function(e,t,o){var a=o("b8c5");"string"===typeof a&&(a=[[e.i,a,""]]),a.locals&&(e.exports=a.locals);var i=o("4f06").default;i("13806aa2",a,!0,{sourceMap:!1,shadowMode:!1})},f827:function(e,t,o){"use strict";o.r(t);var a=o("6d37"),i=o.n(a);for(var n in a)"default"!==n&&function(e){o.d(t,e,(function(){return a[e]}))}(n);t["default"]=i.a}}]);