(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["pages-attendanceModule-pages-attendaceSend-attendaceSend"],{"05b7":function(e,a,t){"use strict";t.r(a);var i=t("9e98"),l=t.n(i);for(var s in i)"default"!==s&&function(e){t.d(a,e,(function(){return i[e]}))}(s);a["default"]=l.a},"191e":function(e,a,t){"use strict";t.r(a);var i=t("9ca1"),l=t("05b7");for(var s in l)"default"!==s&&function(e){t.d(a,e,(function(){return l[e]}))}(s);t("fff8");var n,o=t("f0c5"),c=Object(o["a"])(l["default"],i["b"],i["c"],!1,null,"56b3a85e",null,!1,i["a"],n);a["default"]=c.exports},"9ca1":function(e,a,t){"use strict";var i;t.d(a,"b",(function(){return l})),t.d(a,"c",(function(){return s})),t.d(a,"a",(function(){return i}));var l=function(){var e=this,a=e.$createElement,t=e._self._c||a;return t("v-uni-view",{staticClass:"page"},[t("v-uni-view",{staticClass:"page__bd"},[t("v-uni-view",{staticClass:"weui-cells weui-cells_after-title box_top"},[t("v-uni-view",{staticClass:"weui-cell weui-cell_input"},[t("v-uni-view",{staticClass:"weui-cell__hd"},[t("v-uni-view",{staticClass:"weui-label__text"},[e._v("考勤计划名称")])],1),t("v-uni-view",{staticClass:"weui-cell__ft"},[t("v-uni-input",{staticClass:"weui-input",attrs:{placeholder:e.pageObj.name},on:{input:function(a){arguments[0]=a=e.$handleEvent(a),e.inputPlanName.apply(void 0,arguments)}}})],1)],1),t("v-uni-navigator",{staticClass:"weui-cell weui-cell_access",attrs:{url:e.pageUrl.selectPersonnelUrl,"hover-class":"weui-cell_active"}},[t("v-uni-view",{staticClass:"weui-cell__bd"},[e._v("考勤人员")]),t("v-uni-view",{staticClass:"weui-cell__ft weui-cell__ft_in-access"},[e._v(e._s(e.pageObj.personnel))])],1)],1),t("v-uni-view",{staticClass:"weui-cells weui-cells_after-title box_top"},[t("v-uni-navigator",{staticClass:"weui-cell weui-cell_access",attrs:{url:e.pageUrl.selectWeekUrl,"hover-class":"weui-cell_active"}},[t("v-uni-view",{staticClass:"weui-cell__bd"},[e._v("星期")]),t("v-uni-view",{staticClass:"weui-cell__ft weui-cell__ft_in-access"},e._l(e.pageObj.weekCycle,(function(a,i){return t("v-uni-view",{key:i,staticStyle:{display:"inline-block"}},[e._v(e._s(a)),i!=e.pageObj.weekCycle.length-1?t("v-uni-text",[e._v(",")]):e._e()],1)})),1)],1),t("v-uni-view",{staticClass:"weui-cell weui-cell_access"},[t("v-uni-view",{staticClass:"weui-cell__bd"},[e._v("开始时间")]),t("v-uni-view",{staticClass:"weui-cell__ft"},[t("v-uni-picker",{attrs:{mode:"time",value:e.showStartTime,start:"01:01",end:"23:59"},on:{change:function(a){arguments[0]=a=e.$handleEvent(a),e.bindStartTimeChange.apply(void 0,arguments)}}},[t("v-uni-view",{staticClass:"weui-cell__ft weui-cell__ft_in-access"},[e._v(e._s(e.pageObj.startTime))])],1)],1)],1),t("v-uni-view",{staticClass:"weui-cell weui-cell_access"},[t("v-uni-view",{staticClass:"weui-cell__bd"},[e._v("结束时间")]),t("v-uni-view",{staticClass:"weui-cell__ft"},[t("v-uni-picker",{attrs:{mode:"time",value:e.showEndTime,start:"01:01",end:"23:59"},on:{change:function(a){arguments[0]=a=e.$handleEvent(a),e.bindEndTimeChange.apply(void 0,arguments)}}},[t("v-uni-view",{staticClass:"weui-cell__ft weui-cell__ft_in-access"},[e._v(e._s(e.pageObj.endTime))])],1)],1)],1),t("v-uni-view",{staticClass:"weui-cell weui-cell_access box",attrs:{"hover-class":"weui-cell_active"},on:{click:function(a){arguments[0]=a=e.$handleEvent(a),e.bindDelayTimeChange.apply(void 0,arguments)}}},[t("v-uni-view",{staticClass:"weui-cell__bd more_bd"},[e._v("延迟结束时间")]),t("v-uni-view",{staticClass:"weui-cell__ft"},[e._v(e._s(e.delayTime))]),t("v-uni-view",{staticClass:"weui-cell__ft weui-cell__ft_in-access more_rightIcon"})],1)],1)],1),t("v-uni-view",{staticClass:"page__bd"},[e.isDetail?t("v-uni-view",{staticClass:"weui-btn-area button_top"},[t("v-uni-button",{staticClass:"weui-btn page_submit",attrs:{disabled:e.disabled},on:{click:function(a){arguments[0]=a=e.$handleEvent(a),e.confirmUpdate.apply(void 0,arguments)}}},[e._v("修改")])],1):t("v-uni-view",{staticClass:"weui-btn-area button_top"},[t("v-uni-button",{staticClass:"weui-btn page_submit",attrs:{disabled:e.disabled},on:{click:function(a){arguments[0]=a=e.$handleEvent(a),e.confirmSend.apply(void 0,arguments)}}},[e._v("发送")])],1)],1),t("v-uni-view",{staticClass:"page__bd setLimit-view button_top"},[t("v-uni-view",{staticClass:"weui-article"},[t("v-uni-view",{staticClass:"weui-article__h1 h1-font"},[e._v("温馨提示")]),t("v-uni-view",{staticClass:"weui-article__section"},[t("v-uni-view",{staticClass:"weui-media-box__desc desc-font"},[e._v("1. 默认提前"+e._s(e.advanceTime)+"分钟给每位考勤人员发送考勤通知。")]),t("v-uni-view",{staticClass:"weui-media-box__desc desc-font"},[e._v("2. 开始时间与结束时间的间隔为10 ~ 30分之间。")]),t("v-uni-view",{staticClass:"myui-media-box__desc desc-font"},[e._v("3. 若考勤时间在当天，请注意开始时间应该提前"+e._s(e.advanceTime+5)+"分钟，即开始时间比当前时间晚"+e._s(e.advanceTime+5)+"分钟。实际结束时间为结束时间+延迟时间。")])],1)],1)],1)],1)},s=[]},"9e98":function(e,a,t){"use strict";Object.defineProperty(a,"__esModule",{value:!0}),a.default=void 0;var i=getApp(),l={},s={data:function(){return{pageUrl:i.globalData.PageUrl.attendancePageUrl,pageObj:{},isDetail:!1,planId:"",showStartTime:"请选择",showEndTime:"请选择",advanceTime:0,delayTime:"5分钟",delayIndex:0,disabled:!1}},components:{},props:{},onLoad:function(e){console.log(e),console.log("------------------------创建考勤计划------------------------"),e.planId&&(this.getPlanDetails(e.planId),this.setData({planId:e.planId,isDetail:!0})),this.getAdvanceTime()},onShow:function(){var e=i.globalData.StorageUtil.get("sendPageObjCach");e?this.getPageData(e):this.getPageData()},methods:{getPageData:function(e){var a={};null!=e&&null!=e.name?(a.name=e.name,l.name=e.name):(a.name="请输入名称",l.name="");var t,s=i.globalData.StorageUtil.get("departmentCach"),n=i.globalData.StorageUtil.get("majorCach"),o=i.globalData.StorageUtil.get("classCach");s.length>0||n.length>0||o.length>0?(a.personnel="已选择",t=(this.isDetail,this.dealSelect(s,n,o)),l.attendances=t):(a.personnel="请选择",l.attendances="");var c=i.globalData.StorageUtil.get("attendaceWeekCach");if(c){var r=this.dealWeekValue(c);console.log(r),a.weekCycle=r,l.weekCycle=r}else null!=e&&null!=e.weekCycle?(a.weekCycle=e.weekCycle,l.weekCycle=e.weekCycle):(a.weekCycle="请选择",l.weekCycle="");null!=e&&null!=e.startTime?(a.startTime=e.startTime,l.startTime=e.startTime):(a.startTime="请选择",l.startTime=""),null!=e&&null!=e.endTime?(a.endTime=e.endTime,l.endTime=e.endTime):(a.endTime="请选择",l.endTime=""),this.setData({pageObj:a}),i.globalData.StorageUtil.set("sendPageObjCach",a)},setPageObj:function(e,a,t){var l={},s=i.globalData.StorageUtil.get("sendPageObjCach"),n=s||this.pageObj;l.name=n.name,l.personnel=n.personnel,l.weekCycle=n.weekCycle,l.startTime=n.startTime,l.endTime=n.endTime,l[e]=a,t.setData({pageObj:l}),i.globalData.StorageUtil.set("sendPageObjCach",l)},setRequestObj:function(e,a,t){var i={};i.name=l.name,i.attendances=l.attendances,i.weekCycle=l.weekCycle,i.startTime=l.startTime,i.endTime=l.endTime,i[e]=a,l=i},dealSelect:function(e,a,t){var i={};return i.department=this.selectValue(e,!0),i.profession=this.selectValue(a),i.classes=this.selectValue(t),i},selectValue:function(e,a){for(var t=[],i=0,l=0,s=e.length;l<s;++l)if(e[l].checked){var n={};n.parentId=e[l].parentId,n.childId=e[l].id,a&&(n.parentId=0),t[i]=n,i++}return t},dealWeekValue:function(e){for(var a=[],t=0,i=0,l=e.length;i<l;++i)e[i].checked&&(a[t]=e[i].value,t++);return a},inputPlanName:function(e){""==e.detail.value&&(l.name=""),this.setPageObj("name",e.detail.value,this),this.setRequestObj("name",e.detail.value,this)},bindStartTimeChange:function(e){this.setPageObj("startTime",e.detail.value,this),this.setRequestObj("startTime",e.detail.value,this)},bindStartTime:function(e){var a=new Date,t=a.getMinutes();a.setMinutes(t+e+7);var l=new Date;l.setMinutes(t+e+7+10);var s=i.globalData.PublicUtil.formatTimeTwo(a.getTime(),"h:m"),n=i.globalData.PublicUtil.formatTimeTwo(l.getTime(),"h:m");this.setData({showStartTime:s,showEndTime:n})},bindEndTimeChange:function(e){var a=e.detail.value,t=this.pageObj.startTime;""!==t&&"请选择"!==t?(this.setPageObj("endTime",a,this),this.setRequestObj("endTime",a,this),this.isFeasible()):i.globalData.ShowMsgUtil.showErrorModal("注意","请先设置开始时间！")},isFeasible:function(){var e=this.pageObj.endTime,a=this.pageObj.startTime,t=i.globalData.PublicUtil.formatTimeTwo(new Date,"Y-M-D"),l=t+" "+a+":00",s=t+" "+e+":00",n=new Date(l),o=n.getMinutes();n.setMinutes(o+10);var c=new Date(l);c.setMinutes(o+30);var r=new Date(s).getTime();if(n.getTime()>r||r>c.getTime())return wx.hideToast({}),this.setData({}),void i.globalData.ShowMsgUtil.showErrorModal("注意","开始与结束时间应该在10~30分钟之间！")},confirmSend:function(){console.log(this.planId);var e=this;if(""!=l.name)if(""!=l.startTime)if(""!=l.endTime)if(""!=l.attendances){this.isFeasible();var a=this.isWithinRange(!0);console.log("isRange",a),a?wx.showModal({title:"提示",content:"考勤已过，考勤计划将在明天执行",success:function(a){a.confirm?e.requestSend(e.planId):a.cancel&&console.log("用户点击取消")}}):e.requestSend(e.planId)}else i.globalData.ShowMsgUtil.showErrorModal("发送失败","考勤人员不能为空");else i.globalData.ShowMsgUtil.showErrorModal("发送失败","考勤开始时间不能为空");else i.globalData.ShowMsgUtil.showErrorModal("发送失败","考勤开始时间不能为空");else i.globalData.ShowMsgUtil.showErrorModal("发送失败","考勤名称不能为空")},requestSend:function(e){console.log("planId:  ",e);var a=this;i.globalData.ShowMsgUtil.netErrNotice();var t=i.globalData.StorageUtil.get("userInfoCach"),s=i.globalData.StorageUtil.get("sendPageObjCach");i.globalData.ShowMsgUtil.showLoadToast("正在创建...");var n=l.attendances;uni.request({url:i.globalData.RequestUrl.attendanceRequestUrl.createAttendancePlan,data:{id:e,name:s.name,type:1,weekCycle:s.weekCycle,teacherId:t.personId,startTime:s.startTime,endTime:s.endTime,attendances:n},header:{token:t.token,"content-type":"application/json"},method:"POST",success:function(t){if(wx.hideToast({}),console.log("创建考勤返回",t.data),!t.data||200!=t.data.code)return a.setData({disabled:!1}),void i.globalData.ShowMsgUtil.showErrorModal("请求失败",t.data.msg,t.data.code);e?i.globalData.ShowMsgUtil.showSuccessAndReturn("修改成功",2e3):i.globalData.ShowMsgUtil.showSuccessAndReturn("发送成功",2e3),i.globalData.StorageUtil.remove("attendaceWeekCach"),i.globalData.StorageUtil.remove("departmentCach"),i.globalData.StorageUtil.remove("majorCach"),i.globalData.StorageUtil.remove("classCach"),i.globalData.StorageUtil.remove("sendPageObjCach"),i.globalData.StorageUtil.remove("toWeekCach")},fail:function(){wx.hideToast({}),a.setData({disabled:!1}),i.globalData.ShowMsgUtil.showNoneToastByFail()}})},getPlanDetails:function(e){var a=this,t=i.globalData.StorageUtil.get("userInfoCach");wx.request({url:i.globalData.RequestUrl.attendanceRequestUrl.getAttendancePlanDetail+"?teacherId="+t.personId+"&planId="+e,method:"GET",header:{token:t.token},success:function(e){if(console.log("获取考勤计划详情返回",e.data),e.data&&200==e.data.code){var t=e.data.rows;t.startTime=i.globalData.PublicUtil.formatTimeTwo(t.startTime,"h:m"),t.endTime=i.globalData.PublicUtil.formatTimeTwo(t.endTime,"h:m"),i.globalData.StorageUtil.set("departmentCach",a.dealSelectResponse(t.target.department)),i.globalData.StorageUtil.set("majorCach",a.dealSelectResponse(t.target.profession)),i.globalData.StorageUtil.set("classCach",a.dealSelectResponse(t.target.classes)),i.globalData.StorageUtil.set("toWeekCach",t.weekCycle),a.getPageData(t);var l=a.isWithinRange(!1);wx.hideLoading(),l&&(i.globalData.ShowMsgUtil.showErrorModal("修改失败","考勤执行期间不能修改考勤计划！"),setTimeout((function(){wx.navigateBack({delta:1})}),2e3))}else i.globalData.ShowMsgUtil.showErrorModal("请求失败",e.data.msg,e.data.code)},fail:function(){i.globalData.ShowMsgUtil.showNoneToastByFail()}})},dealSelectResponse:function(e){for(var a=0;a<e.length;a++)e[a].checked=!0,e[a].isDetail=!0;return e},confirmUpdate:function(){console.log(this.planId);var e=this;if(""!=l.name)if(""!=l.startTime)if(""!=l.endTime)if(""!=l.attendances){this.isFeasible();var a=this.isWithinRange(!0);console.log("isRange",a),a?wx.showModal({title:"提示",content:"考勤已过，考勤计划将在明天执行",success:function(a){a.confirm?e.requestSend(e.planId):a.cancel&&console.log("用户点击取消")}}):(this.setData({disabled:!0}),e.requestSend(e.planId))}else i.globalData.ShowMsgUtil.showErrorModal("发送失败","考勤人员不能为空");else i.globalData.ShowMsgUtil.showErrorModal("发送失败","考勤开始时间不能为空");else i.globalData.ShowMsgUtil.showErrorModal("发送失败","考勤开始时间不能为空");else i.globalData.ShowMsgUtil.showErrorModal("发送失败","考勤名称不能为空")},bindDelayTimeChange:function(){var e=this,a=["5分钟","10分钟","15分钟"];wx.showActionSheet({itemList:a,success:function(t){t.cancel||e.setData({delayIndex:t.tapIndex,delayTime:a[t.tapIndex]})}})},getAdvanceTime:function(){var e=this;i.globalData.ShowMsgUtil.netErrNotice();var a=i.globalData.StorageUtil.get("userInfoCach");wx.request({url:i.globalData.RequestUrl.attendanceRequestUrl.getAdvanceTime,method:"GET",header:{token:a.token},success:function(a){console.log("获取提前时间返回",a.data),a.data&&200==a.data.code?(e.setData({advanceTime:a.data.rows}),e.bindStartTime(a.data.rows)):i.globalData.ShowMsgUtil.showErrorModal("请求失败",a.data.msg,a.data.code)},fail:function(){i.globalData.ShowMsgUtil.showNoneToastByFail()}})},isWithinRange:function(e){for(var a=this.pageObj.weekCycle,t=i.globalData.PublicUtil.formatTimeTwo(new Date,"Y-M-D h:m:s"),l=i.globalData.PublicUtil.getDates(1,t),s=0;s<a.length;s++)if(a[s]==l[0].week){var n=this.pageObj.startTime,o=this.pageObj.endTime,c=i.globalData.PublicUtil.formatTimeTwo(new Date,"Y-M-D"),r=c+" "+n+":00",d=c+" "+o+":00",u=new Date(r),g=u.getMinutes();e?u.setMinutes(g-this.advanceTime):u.setMinutes(g-(this.advanceTime+5));var v=new Date(d),w=v.getMinutes(),h=this.dealDelayTime();v.setMinutes(w+h);var m=(new Date).getTime();if(e){if(u.getTime()<=m)return!0}else if(u.getTime()<=m&&m<=v.getTime())return!0}return!1},dealDelayTime:function(){return 0==this.delayIndex?5:1==this.delayIndex?10:1==this.delayIndex?15:5}}};a.default=s},abda:function(e,a,t){var i=t("e7a7");"string"===typeof i&&(i=[[e.i,i,""]]),i.locals&&(e.exports=i.locals);var l=t("4f06").default;l("e870f2ba",i,!0,{sourceMap:!1,shadowMode:!1})},e7a7:function(e,a,t){var i=t("24fb");a=i(!1),a.push([e.i,".desc-font[data-v-56b3a85e]{margin-top:%?10?%}.weui-label__text[data-v-56b3a85e]{width:150px}.myui-media-box__desc[data-v-56b3a85e]{color:#999;font-size:13px;line-height:1.2;overflow:hidden;text-overflow:ellipsis;-webkit-box-orient:vertical;-webkit-line-clamp:2}",""]),e.exports=a},fff8:function(e,a,t){"use strict";var i=t("abda"),l=t.n(i);l.a}}]);